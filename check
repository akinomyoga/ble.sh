#!/bin/bash

if ! type grc >/dev/null; then
  echo 'blesh check: grc not found. grc can be found in github.com:akinomyoga/mshex.git/' >&2
  exit
fi

function check-builtin {
  echo "--- $FUNCNAME ---"
  local command="$1" esc='(\[[ -?]*[@-~])*'
  grc --color --exclude=./test "(^|[^-./\${}])\b$command"'\b([[:space:]|&;<>()`"'\'']|$)' |
    grep -Ev "^$esc([^[:space:]]$esc)+[[:space:]]*#|(\b|$esc)builtin$esc([[:space:]]$esc)+$command(\b|$esc)" |
    grep -Ev "$command(\b|$esc)="
}

function check-bash300bug {
  echo "--- $FUNCNAME ---"
  # bash-3.0 ã§ã¯ local arr=(1 2 3) ã¨ã™ã‚‹ã¨
  # local arr='(1 2 3)' ã¨è§£é‡ˆã•ã‚Œã¦ã—ã¾ã†ã€‚
  grc 'local [a-zA-Z_]+=\(' --exclude=test

  # bash-3.0 ã§ã¯ local -a arr=("$hello") ã¨ã™ã‚‹ã¨
  # ã‚¯ã‚©ãƒ¼ãƒˆã—ã¦ã„ã‚‹ã«ã‚‚æ‹˜ã‚‰ãš $hello ã®ä¸­èº«ãŒå˜èªåˆ†å‰²ã•ã‚Œã¦ã—ã¾ã†ã€‚
  grc 'local -a [[:alnum:]_]+=\([^)]*[\"'\''`]' --exclude=test
  echo
}

function check-bash301bug-array-element-length {
  echo "--- $FUNCNAME ---"
  # bash-3.1 ã§ ${#arr[index]} ã‚’ç”¨ã„ã‚‹ã¨ã€
  # æ—¥æœ¬èªã®æ–‡å­—æ•°ãŒå¤‰ã«ãªã‚‹ã€‚
  grc '\$\{#[[:alnum:]]+\[[^@*]' --exclude=test | grep -Ev '^([^#]*[[:space:]])?#'
  echo
}

function check-assign {
  echo "--- $FUNCNAME ---"
  local command="$1"
  local esc='(\[[ -?]*[@-~])*'
  local rex_grep_head="^$esc[[:graph:]]+$esc:$esc[[:digit:]]*$esc:$esc"
  grc --color --exclude=./test --exclude=./memo '\$\([^()]' |
    grep -Ev "$rex_grep_head#|[[:space:]]#"
}

# builtin return break continue : eval echo unset ã¯ unset ã—ã¦ã„ã‚‹ã®ã§å¤§ä¸ˆå¤«ã®ã¯ãš

#check-builtin 'history'
#check-builtin 'echo'
check-builtin '(bind|compopt|type|printf|read)'
#check-assign

check-bash300bug
check-bash301bug-array-element-length
